<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>ETC1 Compressed Texture Asset Pipeline for Xamarin.Android | Infinitespace Studios</title>
<meta name="generator" content="Jekyll v4.4.1" />
<meta property="og:title" content="ETC1 Compressed Texture Asset Pipeline for Xamarin.Android" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In my last post we looked at using ETC1 compressed textures on the Xamarin Android platform. In that case we just used the texture and some fancy shader magic to fake transparency. In this article we’ll how we can split the alpha channel out to a separate file which we load at run time so we don’t have to rely on the colour key." />
<meta property="og:description" content="In my last post we looked at using ETC1 compressed textures on the Xamarin Android platform. In that case we just used the texture and some fancy shader magic to fake transparency. In this article we’ll how we can split the alpha channel out to a separate file which we load at run time so we don’t have to rely on the colour key." />
<link rel="canonical" href="http://localhost:4000/general/etc1-compressed-texture-asset-pipeline-for-xamarin-android/" />
<meta property="og:url" content="http://localhost:4000/general/etc1-compressed-texture-asset-pipeline-for-xamarin-android/" />
<meta property="og:site_name" content="Infinitespace Studios" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2014-05-23T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="ETC1 Compressed Texture Asset Pipeline for Xamarin.Android" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2014-05-23T00:00:00+01:00","datePublished":"2014-05-23T00:00:00+01:00","description":"In my last post we looked at using ETC1 compressed textures on the Xamarin Android platform. In that case we just used the texture and some fancy shader magic to fake transparency. In this article we’ll how we can split the alpha channel out to a separate file which we load at run time so we don’t have to rely on the colour key.","headline":"ETC1 Compressed Texture Asset Pipeline for Xamarin.Android","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/general/etc1-compressed-texture-asset-pipeline-for-xamarin-android/"},"url":"http://localhost:4000/general/etc1-compressed-texture-asset-pipeline-for-xamarin-android/"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/assets/css/style.css?v=">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Custom head content - add custom meta tags, analytics, etc. here -->

  </head>
  <body>
    <header class="site-header">
      <div class="header-content">
        <a href="/" class="logo-link">
          <img src="/images/issheader.png" alt="Infinitespace Studios" class="site-logo">
          <span class="site-title">Infinitespace Studios</span>
        </a>
        <nav class="main-nav">
          <ul>
            <li><a href="/">Blog</a></li>
            <li><a href="/about">About</a></li>
            <li><a href="/monogame-ports">Ports</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main class="site-content">
      <div class="container">
        <p>In my last post we looked at using ETC1 compressed textures on the Xamarin Android platform. In that case we just used the texture and some fancy shader magic to fake transparency. In this article we’ll how we can split the alpha channel out to a separate file which we load at run time so we don’t have to rely on the colour key.</p>

<p>One of the things that can be a pain is having to pre-process your content to generate compressed textures etc outside of your normal development processes. In this case it would be nice for the artist to give us a .png file and we add it to the project and as part of the build and packaging process we get the required compressed textures in the .apk. XNA did something similar with its content pipeline where all the content was processed during the build into formats optimised for the target platform (xbox, windows etc), <a href="http://monogame.net">MonoGame</a> also has a similar content pipeline as does many other game development tools. Pre-processing your content is really important, because you don’t want to be doing any kind of heavy processing on the device itself. While phones are getting more powerful every year, they still can’t match high end PC’s or consoles. In this article we’ll look and hooking into the power of msbuild and xbuild (<a href="http://xamarin.com">Xamarin’s</a> cross platform version of msbuild) so implement a very simple content processor.</p>

<p>So what we want to do it this, be able to add a .png to our Assets folder in our project and have some magic happen which turns that .png file into a .etc1 compressed texture and save the alpha channel of the .png file to a .alpha file and have those files appear in the .apk. To do this we are going to need a few things</p>

<ol>
  <li>A Custom MSBuild Task to split out and convert the files</li>
  <li>A .targets file in which we can hook into the <a href="http://xamarin.com">Xamarin.Android</a> build process at the right points to call our custom task.</li>
  <li>A way of detecting where the etc1tool is installed on the target system.</li>
</ol>

<p>We’ll start with the .targets file. First thing we need to know where in the <a href="http://xamarin.com">Xamarin.Android</a> build process we need to do our fancy <em>bate and switch</em> of the assets. Turns out after looking into Xamarin.Common.CSharp.targets file the perfect place to hook in is between the <strong><em>UpdateAndroidAssets</em></strong> target and the <strong><em>UpgradeAndroidInterfaceProxies</em></strong> target.  At the point where these targets run there is already a list of the assets in the project stored in the  <strong><em>@(_AndroidAssetsDest)</em></strong> property, which is perfect for what we need. Getting the location of the <strong><em>etc1tool</em></strong> is also a bit of a breeze because again <a href="http://xamarin.com">Xamarin</a> have done the hard work for us, there is a <strong><em>$(AndroidSdkDirectory)</em></strong> property onto which we just need to append tools/etc1tool in order to run the app. So thats 2) and 3) kinda sorted. Lets look at the code for the custom Task.</p>

<div class="language-csharp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">public</span> <span class="k">class</span> <span class="nc">CompressTextures</span> <span class="p">:</span> <span class="n">Task</span>
<span class="p">{</span>
    <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">ITaskItem</span><span class="p">[]</span> <span class="n">InputFiles</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">Required</span><span class="p">]</span>
    <span class="k">public</span> <span class="kt">string</span> <span class="n">AndroidSdkDir</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="p">[</span><span class="n">Output</span><span class="p">]</span>
    <span class="k">public</span> <span class="n">ITaskItem</span><span class="p">[]</span> <span class="n">OutputFiles</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

    <span class="k">public</span> <span class="k">override</span> <span class="kt">bool</span> <span class="nf">Execute</span> <span class="p">()</span>
    <span class="p">{</span>
        <span class="n">Log</span><span class="p">.</span><span class="nf">LogMessage</span> <span class="p">(</span><span class="n">MessageImportance</span><span class="p">.</span><span class="n">Low</span><span class="p">,</span> <span class="s">"  CompressTextures Task"</span><span class="p">);</span>

        <span class="n">List</span> <span class="n">items</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">List</span> <span class="p">();</span>
        <span class="kt">var</span> <span class="n">etc1tool</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">Etc1Tool</span> <span class="p">();</span>
        <span class="n">etc1tool</span><span class="p">.</span><span class="n">AndroidSdkDir</span> <span class="p">=</span> <span class="n">AndroidSdkDir</span><span class="p">;</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">item</span> <span class="k">in</span> <span class="n">InputFiles</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">.</span><span class="nf">Contains</span><span class="p">(</span><span class="s">".png"</span><span class="p">))</span> <span class="p">{</span>
                <span class="kt">var</span> <span class="n">etc1file</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">.</span><span class="nf">Replace</span> <span class="p">(</span><span class="s">".png"</span><span class="p">,</span> <span class="s">".etc1"</span><span class="p">);</span>
                <span class="kt">var</span> <span class="n">alphafile</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">.</span><span class="nf">Replace</span> <span class="p">(</span><span class="s">".png"</span><span class="p">,</span> <span class="s">".alpha"</span><span class="p">);</span>
                <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="k">null</span><span class="p">;</span>

                <span class="k">using</span> <span class="p">(</span><span class="kt">var</span> <span class="n">bitmap</span> <span class="p">=</span> <span class="p">(</span><span class="n">Bitmap</span><span class="p">)</span><span class="n">Bitmap</span><span class="p">.</span><span class="nf">FromFile</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">))</span> <span class="p">{</span>
                    <span class="n">data</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="n">bitmap</span><span class="p">.</span><span class="n">Width</span> <span class="p">*</span> <span class="n">bitmap</span><span class="p">.</span><span class="n">Height</span><span class="p">];</span>
                    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">y</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">y</span> <span class="p">&lt;</span> <span class="n">bitmap</span><span class="p">.</span><span class="n">Height</span><span class="p">;</span> <span class="n">y</span><span class="p">++)</span> <span class="p">{</span>
                        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">x</span> <span class="p">&lt;</span> <span class="n">bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">;</span> <span class="n">x</span><span class="p">++)</span> <span class="p">{</span>
                            <span class="kt">var</span> <span class="n">color</span> <span class="p">=</span> <span class="n">bitmap</span><span class="p">.</span><span class="nf">GetPixel</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
                            <span class="n">data</span> <span class="p">[(</span><span class="n">y</span> <span class="p">*</span> <span class="n">bitmap</span><span class="p">.</span><span class="n">Width</span><span class="p">)</span> <span class="p">+</span> <span class="n">x</span><span class="p">]</span> <span class="p">=</span> <span class="n">color</span><span class="p">.</span><span class="n">A</span><span class="p">;</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
                    
                <span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="n">File</span><span class="p">.</span><span class="nf">WriteAllBytes</span> <span class="p">(</span><span class="n">alphafile</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

                <span class="n">etc1tool</span><span class="p">.</span><span class="n">Source</span> <span class="p">=</span> <span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">;</span>
                <span class="n">etc1tool</span><span class="p">.</span><span class="n">Destination</span> <span class="p">=</span> <span class="n">etc1file</span><span class="p">;</span>
                <span class="n">etc1tool</span><span class="p">.</span><span class="nf">Execute</span> <span class="p">();</span>

                <span class="n">items</span><span class="p">.</span><span class="nf">Add</span> <span class="p">(</span><span class="k">new</span> <span class="nf">TaskItem</span> <span class="p">(</span><span class="n">etc1file</span><span class="p">));</span>
                <span class="n">items</span><span class="p">.</span><span class="nf">Add</span> <span class="p">(</span><span class="k">new</span> <span class="nf">TaskItem</span> <span class="p">(</span><span class="n">alphafile</span><span class="p">));</span>

                <span class="k">if</span> <span class="p">(</span><span class="n">File</span><span class="p">.</span><span class="nf">Exists</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">try</span> <span class="p">{</span>
                    <span class="n">File</span><span class="p">.</span><span class="nf">Delete</span> <span class="p">(</span><span class="n">item</span><span class="p">.</span><span class="n">ItemSpec</span><span class="p">);</span>
                    <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="n">IOException</span> <span class="n">ex</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// read only error??</span>
                        <span class="n">Log</span><span class="p">.</span><span class="nf">LogErrorFromException</span> <span class="p">(</span><span class="n">ex</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>

            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="n">items</span><span class="p">.</span><span class="nf">Add</span> <span class="p">(</span><span class="n">item</span><span class="p">);</span>
            <span class="p">}</span>

        <span class="p">}</span>
        <span class="n">OutputFiles</span> <span class="p">=</span> <span class="n">items</span><span class="p">.</span><span class="nf">ToArray</span> <span class="p">();</span>
        <span class="k">return</span> <span class="p">!</span><span class="n">Log</span><span class="p">.</span><span class="n">HasLoggedErrors</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">class</span> <span class="nc">Etc1Tool</span> <span class="p">{</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Source</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">Destination</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="kt">string</span> <span class="n">AndroidSdkDir</span> <span class="p">{</span> <span class="k">get</span><span class="p">;</span> <span class="k">set</span><span class="p">;</span> <span class="p">}</span>

        <span class="k">public</span> <span class="k">void</span> <span class="nf">Execute</span><span class="p">()</span> <span class="p">{</span>

            <span class="kt">var</span> <span class="n">tool</span> <span class="p">=</span> <span class="n">Path</span><span class="p">.</span><span class="nf">Combine</span> <span class="p">(</span><span class="n">AndroidSdkDir</span><span class="p">,</span> <span class="s">"tools/etc1tool"</span><span class="p">);</span>

            <span class="kt">var</span> <span class="n">process</span> <span class="p">=</span> <span class="k">new</span> <span class="n">System</span><span class="p">.</span><span class="n">Diagnostics</span><span class="p">.</span><span class="nf">Process</span> <span class="p">();</span>
            <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">FileName</span> <span class="p">=</span> <span class="n">tool</span><span class="p">;</span>
            <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">Arguments</span> <span class="p">=</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Format</span> <span class="p">(</span><span class="s">" {0} --encode -o {1}"</span><span class="p">,</span> <span class="n">Source</span><span class="p">,</span> <span class="n">Destination</span><span class="p">);</span>
            <span class="n">process</span><span class="p">.</span><span class="n">StartInfo</span><span class="p">.</span><span class="n">CreateNoWindow</span> <span class="p">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">Start</span> <span class="p">();</span>
            <span class="n">process</span><span class="p">.</span><span class="nf">WaitForExit</span> <span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>I’m not going to go into all the in’s and out’s of writing msbuild tasks, that is what <a href="https://www.google.co.uk/#q=how+to+write+a+msbuild+task">google</a> and <a href="https://www.bing.com/search?q=How+to+write+an+msbuild+task">bing</a> are for :). But if you look at the code we have two <em><strong>[Required]</strong></em> properties , the AndroidSDKDir and the InputFiles. The InputFiles are going to be the list of files we get from <strong><em>@(_AndroidAssetDest)</em></strong> and the AndroidSDKDir is obviously the <em><strong>$(AndroidSdkDirectory)</strong></em> property. We also have an OutputFiles property which we use to populate a list with our new files once we have converted them. The code in the Execute method itself should be fairly easy to follow. For each of the files we extract the alpha channel and save that to a .alpha file, then call out to the etc1tool to compress the .png file to an .etc1 file, note we also deleted the original file so it does not get included in the final .apk. Don’t worry this is a file in the <code class="language-plaintext highlighter-rouge">obj/&lt;Configuration&gt;/assets</code> directory not the original file we added to the project :).  Now we could make this more robust and make it conditional so it doesn’t compress every .png in the assets list , but for now this will do the trick. So with the task code done, the .targets file now looks like this.</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span>
<span class="nt">&lt;Project</span> <span class="na">xmlns=</span><span class="s">"http://schemas.microsoft.com/developer/msbuild/2003"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;UsingTask</span> <span class="na">TaskName=</span><span class="s">"InfiniteSpace.Framework.Build.Tasks.CompressTextures"</span> <span class="na">AssemblyFile=</span><span class="s">"InfiniteSpace.Framework.Build.Tasks.dll"</span><span class="nt">/&gt;</span>

  <span class="nt">&lt;Target</span> <span class="na">Name=</span><span class="s">"_CompressAssets"</span> <span class="na">AfterTargets=</span><span class="s">"UpdateAndroidAssets"</span> 
      <span class="na">BeforeTargets=</span><span class="s">"UpdateAndroidInterfaceProxies"</span><span class="nt">&gt;</span>
     <span class="nt">&lt;CompressTextures</span> <span class="na">InputFiles=</span><span class="s">"@(_AndroidAssetsDest)"</span> <span class="na">AndroidSdkDir=</span><span class="s">"$(AndroidSdkDirectory)"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;Output</span> <span class="na">TaskParameter=</span><span class="s">"OutputFiles"</span> <span class="na">ItemName=</span><span class="s">"_CompressedTextures"</span><span class="nt">/&gt;</span>
     <span class="nt">&lt;/CompressTextures&gt;</span>
     <span class="nt">&lt;Touch</span> <span class="na">Files=</span><span class="s">"@(_CompressedTextures)"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/Target&gt;</span>
<span class="nt">&lt;/Project&gt;</span>
</code></pre></div></div>

<p>Again this should be fairly easy to follow. The important bits are the <strong><em>AfterTargets</em></strong> and <strong><em>BeforeTargets</em></strong> values, this is where we hook into the build process. The next step is to include this target file in our project, we do this by adding the following line just under the Import statement for Xamarin.Android.CSharp.targets (or Novell.MonoDroid.CSharp.targets)</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;Import</span> <span class="na">Project=</span><span class="s">"$PATH$/InfiniteSpace.Framework.Build.Tasks/Infinitespace.Common.targets"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>

<p>Now the $PATH$ bit depends on where you put the build tasks. For me I just added the project to my solution and used “../InfiniteSpace.Framework.Build.Tasks/Infinitespace.Common.targets”, then did a small tweak in the .targets file so it loaded the assembly from the debug folder</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">AssemblyFile</span><span class="o">=</span><span class="s2">"./bin/</span><span class="si">$(</span>Configuration<span class="si">)</span><span class="s2">/InfiniteSpace.Framework.Build.Tasks.dll"</span>
</code></pre></div></div>

<p>This worked for me in Xamarin Studio on the mac, and it sort of worked in Visual Studio on windows. However in both IDE’s if you want to change the Task code you need to close and re-load the IDE since the assembly gets loaded during the build process and cannot be overwritten after that.</p>

<p>So with the msbuild task stuff hooked in, you should now be able to add a .png file to your assets folder and have it produce a .etc1 and .alpha for that file in your .apk. After that you can just load the .etc1 and .alpha files as you would any other resource. The <a href="https://github.com/infinitespace-studios/Blog/tree/master/Etc1ContentPipeline">code</a> for this blog entry includes a sample project so you can see exactly how to load the files and use them for alpha.</p>

<p>As mentioned already the CompressTextures task could be improved. Some ideas might be</p>

<ul>
  <li>Add the ability to compress other formats (PVRTC, ATITC, S3TC)</li>
  <li>Add the ability to read additional properties from the TaskItem to control if it needs to be compressed or not</li>
  <li>Add support for Resizing to a Power of 2 (POW2) ETC1 only supports POW2 textures I think.. PVRTC certainly only supports POW2.</li>
  <li>Add support for Colour Key, this wouldn’t save the .alpha file.</li>
  <li>Add support for compressing the alpha channel to etc1.</li>
</ul>

<p>I’ll leave these ideas with you at the moment, I might look at implementing them myself at some point in the future. I know I mentioned looking at PVRTC , ATITC and S3TC texture support in my last article and I assure you I will get to that soon. In the meantime have fun playing with the code and I hope you find it useful.</p>

<p>The code for this blog entry can be downloaded from <a href="https://github.com/infinitespace-studios/Blog/tree/master/Etc1ContentPipeline">https://github.com/infinitespace-studios/Blog/tree/master/Etc1ContentPipeline</a>.</p>

      </div>
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; 2009-2026 Infinitespace Studios. All rights reserved.</p>
        <div class="social-links">
          <a href="https://github.com/dellis1972" aria-label="GitHub">GitHub</a>
          <a href="https://mastodon.gamedev.place/@infspacestudios" aria-label="Mastodon">Mastodon</a>
        </div>
      </div>
    </footer>
  </body>
</html>